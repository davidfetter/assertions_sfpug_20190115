<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<meta property="og:title" content="ASSERTIONs" />
		<meta property="og:description" content="and how to use them" />
		<meta name="author" content="David Fetter">


		<title>ASSERTIONs and how to use them</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/solarized.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h3>ASSERTIONs</h3>
					<h5>and how to use them</h5>
				</section>
				<section>
					<h3>David Fetter</h3>
					<span class="fragment">PostgreSQL Contributor, Advocate, and Occasional Commitfest Manager</span>
				</section>
                <section>
                    <h3>What are they?</h3>
                    <ul>
                        <span class="fragment">Data constraints </span>
                        <span class="fragment">expressed in <strong>SQL</strong> </span><br/>
                        <span class="fragment">which can span multiple tables </span>
                        <span class="fragment">in ways we haven't been able to before</span><span class="fragment">!</span>
                    </ul>
                </section>
                <section style="text-align:left">
                    <h2>Tool Lending Library</h2>
                    Fungible tools which people check out to use.<br/>
                    Track this correctly.<br/>
                </section>
                <section>
                    <section data-markdown>
                        <textarea data-template>
                        ```sql
                        CREATE TABLE IF NOT EXISTS available_tool (
                            tool_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                            tool_type TEXT NOT NULL,
                            available INTEGER DEFAULT 5 NOT NULL,
                            CHECK(available >= 0)
                        );
                        ```
                        </textarea>
                    </section>
                </section>
                <section>
                    <section data-markdown>
                        <textarea data-template>
                        ```sql
                        CREATE TABLE IF NOT EXISTS checked_out_tool (
                            checked_out_by TEXT NOT NULL,
                            tool_id INTEGER NOT NULL REFERENCES available_tool
                        );
                        ```
                        </textarea>
                    </section>
                </section>
                <section>
                    <section data-markdown>
                        <textarea data-template>
                        ```sql
                        CREATE ASSERTION out_of_tools CHECK(
                            NOT EXISTS (
                                SELECT 1
                                FROM
                                    available_tool a
                                JOIN
                                    checked_out_tool d
                                    ON (
                                        a.tool_id = d.tool_id
                                    )
                                GROUP BY a.tool_id
                                HAVING count(*) > a.available
                            )
                        );
                        ```
                        </textarea>
                    </section>
                </section>
                <section>
                    <h1>Live demo!</h1>
                </section>
                <section>
                    <h3>...almost worked</h3>
                    <aside class="notes">We need people working on this patch!</aside>
                </section>
                <section>
                    <h3>PostgreSQL 11?</h3>
                </section>
                <section>
                    <h1>Nope :(</h1>
                    <aside class="notes">Can get this effect in 11?</aside>
                </section>
                <section>
                    <h1>Yes!</h1>
                    <aside class="notes">Is it elegant or easy to get right?</aside>
                </section>
                <section>
                    <h1>No!</h1>
                </section>
                <section>
                    <h3>How?</h3>
                </section>
                <section data-transition="none">
                    <h3>A trigger</h3>
                </section>
                <section data-transition="none">
                    <h3>...with its own function</h3>
                </section>
                <section data-transition="none">
                    <h3>...for each table</h3>
                </section>
                <section data-transition="none">
                    <h3>...for each ASSERTION</h3>
                </section>
                <section data-transition="none">
                    <h3>Let's get started.</h3>
                </section>
                <section>
                    Trigger function for reaching from available to checked_out
                    <section data-markdown>
                        <textarea data-template>
                        ```sql
                        CREATE OR REPLACE FUNCTION check_checked_out_from_available()
                        RETURNS TRIGGER
                        LANGUAGE plpgsql
                        AS $$
                        DECLARE tool TEXT;
                        BEGIN
                            SELECT INTO tool a.tool_type
                            FROM available_tool a JOIN checked_out_tool d
                                ON (
                                    a.tool_id = d.tool_id AND
                                    d.tool_id = NEW.tool_id
                                )
                            GROUP BY a.available, a.tool_type
                            HAVING count(*) > a.available;

                            IF FOUND THEN
                                RAISE 'People have already checked out all the %s.',
                                    tool
                                USING
                                    ERRCODE = 'integrity_constraint_violation',
                                    HINT = 'Consider getting more.';
                            END IF;
                            RETURN NEW;
                        END;
                        $$;
                        ```
                        </textarea>
                    </section>
                </section>
                <section>
                    And the trigger
                    <section data-markdown>
                        <textarea data-template>
                        ```sql
                        CREATE TRIGGER check_checked_out_from_available
                            AFTER INSERT OR UPDATE ON available_tool
                            FOR EACH ROW
                                EXECUTE PROCEDURE check_checked_out_from_available();
                        ```
                        </textarea>
                    </section>
                </section>
                <section>
                    Trigger function for reaching out from available to checked_out
                    <section data-markdown>
                        <textarea data-template>
                        ```sql
                        CREATE OR REPLACE FUNCTION check_available_from_checked_out()
                        RETURNS TRIGGER
                        LANGUAGE plpgsql
                        AS $$
                        DECLARE
                            r RECORD;
                        BEGIN
                            SELECT tool_type, available INTO r
                            FROM available_tool a JOIN checked_out_tool d USING (tool_id)
                            WHERE NEW.tool_id = d.tool_id
                            GROUP BY d.tool_id, a.tool_type, a.available
                            HAVING count(*) > a.available;

                            IF FOUND THEN
                                RAISE 'There are already % checked-out %s.', r.available, r.tool_type
                                    USING
                                        ERRCODE = 'integrity_constraint_violation',
                                        HINT = 'Some of those tools need to come back first';
                            END IF;
                            RETURN NEW;
                        END;
                        $$;

                        ```
                        </textarea>
                    </section>
                </section>
                <section>
                    And <em>its</em> trigger
                    <section data-markdown>
                        <textarea data-template>
                        ```sql
                        CREATE TRIGGER check_available_from_checked_out
                            AFTER INSERT OR UPDATE ON checked_out_tool
                            FOR EACH ROW
                                EXECUTE PROCEDURE check_available_from_checked_out();
                        ```
                        </textarea>
                    </section>
                </section>
                <section>
                    <h1>Another live demo!</h1>
                </section>
                <section>
                    <h1>How did we get here?</h1>
                </section>
                <section>
                    A Relational Model for Large Shared Data Banks
                </section>
                <section>
                    <h1>Nah!</h1>
                </section>
                <section>
                    Serializable Snapshot Isolation in PostgreSQL<br/>
                    Dan Ports and Kevin Grittner
                    <aside class="notes">Talk a little bit about SSI and
                        dependency graphs.
                    </aside>
                </section>
                <section>
                    <pre>From: 	Peter Eisentraut <peter_e(at)gmx(dot)net>
To: 	pgsql-hackers <pgsql-hackers(at)postgresql(dot)org>
Subject: 	[PATCH] SQL assertions prototype
Date: 	2013-11-15 03:30:16
Message-ID: 	1384486216.5008.17.camel@vanquo.pezone.net</pre>
                </section>
                <section>
                    <h3>Note date</h3>
                    Date: <span style="color:red">2013</span>-11-15 03:30:16</pre>
                </section>
                <section>
                    Years pass
                </section>
                <section>
                    Then
                </section>
                <section>
                    <pre>From: 	Joe Wildish <joe-postgresql(dot)org(at)elusive(dot)cx>
To: 	PostgreSQL Hackers <pgsql-hackers(at)postgresql(dot)org>
Subject: 	Re: Implementing SQL ASSERTION
Date: 	2018-01-14 23:33:08
Message-ID: 	985632EC-3E39-4C51-B47A-ED0ABF63D64F@elusive.cx
Views: 	Raw Message | Whole Thread | Download mbox

Hackers,

Attached is a WIP patch for SQL assertion. I am posting it for anyone who might
be interested in seeing it, for comments/feedback, and to see if others are keen
to collaborate on taking it further. It is not near production-ready (see
thoughts on that below).</pre>
                </section>
                <section>
                    A few months later...
                </section>
                <section>
                    <pre style="font-size:18px;">From: 	Joe Wildish <joe-postgresql(dot)org(at)elusive(dot)cx>
To: 	David Fetter <david(at)fetter(dot)org>, PostgreSQL Hackers <pgsql-hackers(at)postgresql(dot)org>
Subject: 	Re: Implementing SQL ASSERTION
Date: 	2018-04-29 18:18:00

Attached is a rebased patch for the prototype.

Cheers,
-Joe</pre>
                </section>
                <section>
                    <h3 align="top">What's in the box?</h3>
                    <ul>
                        <span class="fragment">Documentation</span><br/>
                        <span class="fragment">pg_catalog</span><br/>
                        <span class="fragment">Information schema</span><br/>
                        <span class="fragment">SQL grammar</span><br/>
                        <span class="fragment">CREATE, ALTER, and DROP support</span><br/>
                        <span class="fragment">planner and executor</span><br/>
                    </ul>
                </section>
                <section>
                    <ul>
                        <span class="fragment">Questions?<br/></span>
                        <span class="fragment">Comments?<br/></span>
                    </ul>
                </section>
                <section>
                        Thanks!<br/>
                        Merci!<br/>
                        谢谢！<br/>
                        ありがとう！<br/>
                        ¡Gracias!<br/>
                        Teşekkürler!<br/>
                        धन्यवाद<br/>
                        Спасибо!<br/>
                </section>
			</div>
		</div>
		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
    <style type="text/css">
        /* 1. Style header/footer <div> so they are positioned as desired. */
        #footer-left {
            position: absolute;
            bottom: 5%;
            left: 5%;
            font-size: 50%;
        }
        #footer-right {
            position: absolute;
            bottom: 5%;
            right: 15%;
        }
        ul {
            list-style-type: none;
        }
    </style>

    <!-- 2. Create hidden header/footer <div> -->
    <div id="hidden" style="display:none;">
        <div id="header">
            <div id="header-left"></div>
            <div id="header-right"></div>
            <div id="footer-left">
                David Fetter<br/>
                SFPUG<br/>
                January 15, 2019<br/>
                <a href=mailto:david@fetter.org>david@fetter.org</a></div>
            <!-- div id="footer-right">
                <a href="https://www.authentic8.com"
                alt="www.authentic8.com"><img src="Authentic8-1152x288.jpg"
                alt="Authentic8 Logo" width="192" height="48"/></a></div -->
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script type="text/javascript">
        // 3. On Reveal.js ready event, copy header/footer <div> into each `.slide-background` <div>
        var header = $('#header').html();
        if ( window.location.search.match( /print-pdf/gi ) ) {
            Reveal.addEventListener( 'ready', function( event ) {
                $('.slide-background').append(header);
            });
        }
        else {
            $('div.reveal').append(header);
       }
    </script>

	</body>
</html>
